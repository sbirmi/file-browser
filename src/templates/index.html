<html>
<head>
   <title>File browser</title>

<style>
h1 {font-size: 16px;}
h2 {font-size: 14px;}
thead {font-size: 14px;}
td {padding: 4px;}
.error {background-color: red; color: black; font-weight: bold; border-radius: 4px; border: solid red 1px;}
.message {background-color: orange; border-radius: 4px;}

.ui_date_div::after {content: ""; clear: both; display: table;}
.ui_date_banner {background-color: #e0e0e0; border-radius: 5px; border-left: solid 5px; font-size: 120%; margin-top: 10px; margin-left: 5px; padding-left: 5px;}

.ui_tile {float: left; width: 250px; height: 250px; background-color: #e0e0e0; border-radius: 5px; margin: 5px; white-space: nowrap; text-align: center;}
.ui_tile_align_span {display: inline-block; height: 100%; vertical-align: middle;}
.ui_thumbnail_img {vertical-align: middle;}

.ui_search {font-size: 120%; display: block; border: none; border-bottom: solid 1px #404040;}
.ui_search_feedback {font-style: italic; text-color: #ff8080;}
</style>

<script>

   const MIN_SEARCH_LENGTH = 3;

   let month_repr = {
      0: "Jan",
      1: "Feb",
      2: "Mar",
      3: "Apr",
      4: "May",
      5: "Jun",
      6: "Jul",
      7: "Aug",
      8: "Sep",
      9: "Oct",
      10: "Nov",
      11: "Dec"};

   // -------------------------------------------
   // UI helper fns

   function del_all_children(ui_ele) {
      while (ui_ele.firstChild) {
            ui_ele.removeChild(ui_ele.lastChild);
      }
   }

   // -------------------------------------------
   // UI fns
   function ui_link(url, cls=null) {
      let node = document.createElement("a");
      node.href = url;
      if (cls) {
         node.classList.add(cls);
      }
      return node;
   }

   function ui_img(url, tooltip, cls=null) {
      let img = document.createElement("img");
      img.src = url;
      img.title = tooltip;
      if (cls) {
         img.classList.add(cls);
      }
      return img;
   }

   function ui_div(content, cls=null) {
      let node = document.createElement("div");
      if (content) {
         node.appendChild(content);
      }
      if (cls) {
         node.classList.add(cls);
      }
      return node;
   }

   function ui_br() {
      return document.createElement("br");
   }

   function ui_span(cls=null) {
      let node = document.createElement("span");
      if (cls) {
         node.classList.add(cls);
      }
      return node;
   }

   function ui_text(txt) {
      let node = document.createTextNode(txt);
      return node;
   }

   // -------------------------------------------
   // Object definitions

   class Store {
      constructor() {
         this.fdata = [];
         this.section_by_date = {};

         this.ui = document.getElementById("ui_file_list");
      }

      count() {
         return this.fdata.length;
      }

      clear() {
         this.fdata = [];
         this.section_by_date = {};
         del_all_children(this.ui);

         let ui_showing_count = document.getElementById("ui_showingcount");
         del_all_children(ui_showing_count);
         ui_showing_count.appendChild(ui_div(ui_text(store.count())));
      }

      new_tile(tile) {
         this.fdata.push(tile);
         let dt = tile.file_date;
         let section = this.section_by_date[dt];

         if (section === undefined) {
            section = new Section(this.ui, dt);
            this.section_by_date[dt] = section;
         }

         section.add_tile(tile);
      }
   }

   class Section {
      constructor(parent_ui, dt) {
         this.parent_ui = parent_ui;
         this.dt = dt; // date
         this.tiles = [];

         // Create UI
         let date_repr = month_repr[dt.getMonth()] + " " + dt.getDate() + ", " + dt.getFullYear();
         this.ui_date_banner = ui_div(ui_text(date_repr), "ui_date_banner");

         this.ui = ui_div(null, "ui_date_div");

         this.parent_ui.appendChild(this.ui);
         this.ui.appendChild(this.ui_date_banner);
      }

      add_tile(tile) {
         this.tiles.push(tile);
         tile.add_to_section(this);
      }
   }

   class Tile {
      constructor(data) {
         this.fname = data[0]; //fname;
         this.exif = data[6]; //exif;
         this.file_ts = data[8]; //file_ts;
         this.thumbnail = data[9]; //thumbnail;

         // Sample input: 2022-01-03 20:19:03
         let dttm = this.file_ts.split(" ");
         let dtargs = dttm[0].split("-");
         this.file_date = new Date(dtargs[0] * 1, dtargs[1] * 1 - 1, dtargs[2] * 1);

         this.section = null;

         this._visible = null;

         // Create UI
         this.ui = ui_div(null, "ui_tile");
         let link = ui_link("/get/" + this.fname);
         if (this.thumbnail == null) {
            // No thumbnail
            let ext = this.fname.split(".").pop().substr(0, 6).toLowerCase();
            let content = ui_div(ui_text(ext));
            content.appendChild(ui_br());
            content.appendChild(ui_text(this.fname));
            link.appendChild(content);

         } else {
            // Has thumbnail
            let content = ui_img("thumbnails/" + this.thumbnail,
                                 this.fname + "\n" + this.exif["FileSize"] + " bytes",
                                 "ui_thumbnail_img");
            link.appendChild(content);
            let span = ui_span("ui_tile_align_span");
            this.ui.appendChild(span);
         }
         this.ui.appendChild(link);
      }

      add_to_section(section) {
         this.section = section;
         section.ui.appendChild(this.ui);
      }

      visibility_set(val) {
         this._visibile = val;
      }

      visibility_toggle() {
         this.visibility_set(!this._visible);
      }
   }

   class HttpRequest {
      constructor() {
         this.xmlHttp = new XMLHttpRequest();
         this.xmlHttp.querier_ = this;
         this.xmlHttp.onreadystatechange = this.onreadystatechange;
      }

      onreadystatechange() {
         if (this.readyState == 4 && this.status == 200) {
            let response_json = JSON.parse(this.responseText);
            this.querier_.handle_response_json(response_json);
         }
      }

      do_request(url, args) {
         let args_str = "";
         for (let key in args) {
            let val = args[key];
            if (args_str) {
               args_str += "&";
            }
            args_str += key + "=" + val;
         }
         this.xmlHttp.open("GET", url + "?" + args_str, true);
         this.xmlHttp.send(null);
      }

      handle_response_json(response) {
         alert("JSON handler not overridden");
      }
   }

   class Query extends HttpRequest {
      constructor(search_text) {
         super();

         this.start = 0;   // Items to get start at this index
         this.count = 50; // Number of items to fetch from the server

         this.search_text = search_text;
         console.log("Searching for: " + search_text);

         this.last_query_start_at = null;
         this.do_request();
      }

      handle_response_json(response) {
         // Response can be:
         //
         //    ["ERROR", <str:explanation>]
         //
         //    [ [<str:fname>, <str:hash_sha256>,
         //       <ts:time_db_added>, <ts:time_db_updated>,
         //       <bool:deleted>, <txt:desc>,
         //       <json:exif>, <str:mime_type>,
         //       <ts:exif_img_create_date>, <str:thumbnail>],
         //      [...],
         //    ]
         //
         //    []  < No more data to send

         let ui_search_feedback = document.getElementById("ui_search_feedback");
         del_all_children(ui_search_feedback);
         if (response [0] == "ERROR") {
            ui_search_feedback.appendChild(ui_text(response[1]));
            return;
         }

         if (this.start == 0) {
            store.clear();
         }

         if (store.count() != this.start) {
            console.log("Items in store: " + store.count());
            console.log("this.start: " + this.start);
            alert("Something unexpected happened");
            return;
         }

         console.log("Response [" + this.start + ", " + (this.start + response.length) + "]");
         this.start += response.length;

         if (response.length == 0) {
            console.log("Reached the end");
            this.count = 0;
            return;
         }

         for (let fname in response) {
            let data = response[fname];
            store.new_tile(new Tile(data));
         }

         let ui_showing_count = document.getElementById("ui_showingcount");
         del_all_children(ui_showing_count);
         ui_showing_count.appendChild(ui_div(ui_text(store.count())));
      }

      do_request() {
         if (this.count == 0 || this.last_query_start_at == this.start) {
            return;
         }

         this.last_query_start_at = this.start;
         super.do_request("/db", {"start": this.start,
                                  "count": this.count,
                                  "search": this.search_text});
      }
   }

   class DbStats extends HttpRequest {
      constructor() {
         super();
         this.do_request();
      }

      handle_response_json(response) {
         // Response can be:
         //
         //    ["ERROR", <str:explanation>]
         //
         //    [<str:diskusage>,
         //     <int:filecount>]
         if (response[0] == "ERROR") {
            console.log(response);
            return;
         }

         let ui_upload_dir_du = document.getElementById("ui_upload_dir_du");
         del_all_children(ui_upload_dir_du);
         ui_upload_dir_du.appendChild(ui_div(ui_text(response[0])));

         let ui_filecount = document.getElementById("ui_filecount");
         del_all_children(ui_filecount);
         ui_filecount.appendChild(ui_div(ui_text(response[1] + " files")));
      }

      do_request() {
         super.do_request("/db-stats", {});
      }
   }

   // -------------------------------------------
   // Global variables

   let store = null;
   let current_query = null;
   let db_stats_query = null;

   // -------------------------------------------
   // Entry points

   function init() {
      store = new Store();
      db_stats_query = new DbStats();
      search();
   }

   function query_start(txt) {
      current_query = new Query(txt);
   }

   function query_more_hits() {
      if (!current_query) {
         return;
      }
      current_query.do_request();
   }

   function search() {
      if (search.last_text == null) {
         search.last_text = null;
      }

      let ui_search = document.getElementById("ui_search");
      let search_text = ui_search.value;
      let last_text = search.last_text;

      if (last_text != null && last_text.length < MIN_SEARCH_LENGTH) {
         last_text = "";
      }
      if (search_text.length < MIN_SEARCH_LENGTH) {
         search_text = "";
      }

      if (last_text == search_text) {
         return;
      }
     
      query_start(search_text);
      search.last_text = search_text;
   }

   // -------------------------------------------
   // Code to run when the page is loaded

   window.addEventListener('scroll', function (event) {
      let element = event.target;
      const tile_height = 300;
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - tile_height) {
         query_more_hits();
      }
   });

</script>
</head>

<body onload="init();">
   <table width=100% border=0px> <!-- top bar -->
      <tr>
         <td><h1>File Browser</h1></td>
         <td align=right> <!-- upload pane -->
            <form method="POST" enctype="multipart/form-data" action="/upload">
               <input type="file" name="files" multiple="" style="font-size: 120%;">
               <input type="submit" value="Upload" style="font-size: 120%;">
            </form>
         </td>
      </tr>
   </table>

   {% if error %}
   <p class="error">{{error}}</p>
   {% endif %}

   {% if message %}
   <p class="message">{{message}}</p>
   {% endif %}

   {% if failed_uploads %}
   <h2 class="error">Failed to upload ({{failed_upload_count}}) files</h2>
   <ul>
      {% for filename in failed_uploads %}
         <li>{{filename}}</li>
      {% endfor %}
   </ul>
   {% endif %}

   <!-- Bar above file listing -->
   <table>
      <tr>
         <td id="ui_showingcount"></td>
         <td>/</td>
         <td id="ui_filecount"></td>
         <td id="ui_upload_dir_du"></td>
         <td><input type="text" id="ui_search" class="ui_search" placeholder="search..." oninput="search();"><label id="ui_search_feedback" class="ui_search_feedback"></label></td>
      </tr>
   </table>

   <!-- file listing -->
   <div width="100%" id="ui_file_list"></div>

   <hr>

   {% if uploaded_files %}
   <h2>Uploaded</h2>
   {% endif %}
   <ul>
   {% for filename in uploaded_files %}
      <li>{{filename}}</li>
   {% endfor %}
   </ul>


</body>
</html>
